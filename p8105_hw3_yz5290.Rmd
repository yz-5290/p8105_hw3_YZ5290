---
title: "p8105_hw3_YZ5290"
output: github_document
date: "2025-10-13"
---

Problem 1
```{r}
library(tidyverse)
library(patchwork)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```

```{r}
library(p8105.datasets)
data("instacart")
```
```{r}
instacart
```
The dataset contains 138461 observations and 15 variables. Each observation is a single product from an Instacart order. Key variables include order_id: a different ID for each order; product_id: a different ID for each product and product_name which is the name of the product. The example product 	
Bulgarian Yogurt has unique product id 49302 belong to yogurt aisel is in order id 1 and has reordered once. 

```{r}
instacart|>
  count(aisle, sort = TRUE)
```
There are 134 aisle in total and the most items ordered from fresh vergetables. 
```{r}
instacart |>
  count(aisle, sort = TRUE) |>
  filter(n > 10000) |>
  mutate(aisle = fct_reorder(aisle, n)) |>
  ggplot(aes(x = n, y = aisle)) +
  geom_col(fill = "skyblue") +
  labs(
    title = "Number of Items Ordered by Aisle (>10,000 orders)",
    x = "Number of Items Ordered",
    y = "Aisle"
  )
```

```{r}
instacart |>
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) |>
  count(aisle, product_name, name = "num_orders") |>
  group_by(aisle) |>
  slice_max(order_by = num_orders, n = 3) |>
  ungroup() |>
  knitr::kable()


```
```{r}
mean_hour_table=
  instacart |>
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) |>
  group_by(product_name, order_dow) |>
  summarize(mean_hour = mean(order_hour_of_day), .groups = "drop") |>
  pivot_wider(
    names_from = order_dow,
    values_from = mean_hour,
    names_prefix = "Day"
  )
mean_hour_table

mean_hour_table |>
  rename(
    Sunday=Day0,
    Monday=Day1,
    Tuesday=Day2,
    Wednesday=Day3,
    Thursday=Day4,
    Friday=Day5,
    Saturday=Day6
  )|>
  knitr::kable()

```

problem2

```{r}
zipcode=read_csv("data/zipcode.csv")|>
  janitor::clean_names()
zori=read_csv("data/zori.csv")|>
  janitor::clean_names()
```
```{r}
#clean data
zipcode_new=
  zipcode|>
  select(zip_code, county, neighborhood) |>
  distinct(zip_code, .keep_all = TRUE) |>
  mutate(zip_code = as.character(zip_code))

zori_new = 
  zori |>
  select(region_id, size_rank, region_name, region_type, 
         state_name, state, city, metro, county_name,
         x2015_01_31:x2024_08_31) |>
  pivot_longer(
    cols = x2015_01_31:x2024_08_31,
    names_to = "date_str",
    values_to = "rent_price"
  ) |>
  mutate(
    date_str_clean = str_remove(date_str, "^x") |> str_replace_all("_", "-"),
    date = as.Date(date_str_clean, format = "%Y-%m-%d"),
    zip_code = as.character(region_name)
  ) |>
  select(-date_str, -date_str_clean, -region_name)

```

```{r}
final_data = zori_new |>
  left_join(zipcode_new, by = "zip_code") |>
  select(zip_code, county, neighborhood, date, rent_price, everything()) |>
  arrange(zip_code, date)
```

##count month
```{r}
zip_obs_count=
  final_data |>
  group_by(zip_code) |>
  summarise(
    n_146 = n(),
    n_0 = sum(!is.na(rent_price))
  )

n_146_obs = sum(zip_obs_count$n_146 == 116)
n_0_obs = sum(zip_obs_count$n_0 < 10)
```

There are 149 zipcodes are observed 116 month and there are 26 zip code observed fewer than 10 months. 
Some zipcodes reported monthly can have data for 116 months. Some zipcode do not contain residential house like unique university zipcode might not have rent price to report. 

##make a table (average rental price in each borough and year)
```{r}
borough_t=
  final_data |>
  mutate(year = year(date)) |>
  filter(!is.na(county), !is.na(rent_price)) |>
  group_by(county, year) |>
  summarise(
    avg_rent = mean(rent_price, na.rm = TRUE),
    n_zips = n_distinct(zip_code),
    .groups = "drop"
  ) |>
  arrange(county, year)
borough_t |>
  select(county, year, avg_rent) |>
  pivot_wider(
    names_from = year,
    values_from = avg_rent
  ) |>
  mutate(across(where(is.numeric), ~round(., 2))) |>
  knitr::kable(
    caption = "Average Rent for each County and Year"
  )
  

```
##comments on the trend:
the rental price for each country increase over year. New York has the highest rental price every year and bronx has the lowest every year. 

#plot showing NYC Rental Prices within ZIP codes for all available years. Your plot should facilitate comparisons across boroughs

```{r}
plot1=
  final_data |>
  filter(!is.na(county), !is.na(rent_price)) |>
  mutate(year_month = floor_date(date, "month")) |>
  group_by(county, year_month) |>
  summarise(
    median_rent = median(rent_price, na.rm = TRUE),
    .groups = "drop"
  ) |>
  ggplot(aes(x = year_month, y = median_rent, color = county)) +
  geom_point(size=0.8) +
  labs(
    title = "NYC Rental Prices by Borough (2015-2024)",
    x = "Date", 
    y = "Median Rent",
    color = "Borough"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
plot1
```

##comment: 
Overall, the rent price increased from 2015 to 2024. But in New York contry, rent pricedecerase from 2020 fall to 2021, which appear to be a huge drop. This is not seen in the previous table. Bronx and Queens also has a little drop in the same timee period. 


#Compute the average rental price within each ZIP code over each month in 2023
```{r}
zip_2023_avg=
  final_data|>
  mutate(year = year(date))|>
  filter(year == 2023, !is.na(rent_price), !is.na(county)) |>
  group_by(zip_code, county)|>
  summarise(
    avg_rent = mean(rent_price, na.rm = TRUE),
    .groups="drop"
  )

plot2=
  ggplot(zip_2023_avg, aes(x = avg_rent, y = county, fill = county))+
  geom_boxplot(alpha = 0.6) +
  labs(
    title = "Distribution of ZIP-code-level Rental Prices by Borough (2023)",
    x="Average Rent",
    y="Borough"
  )+
  theme_minimal()+
  theme(legend.position = "none")

plot2
```
#comment:
New York county has the highest average rental price with the largest range. Kings the the second highest average rental price. Richmond has lowest range. THe bronx has lowest average rental pricebut richmond's average rntal price is slight more than Bronx's.

#combine two graph and export. 
```{r}
combined_plot=
  plot1 /plot2



ggsave("result/nyc.png", combined_plot, 
       width = 12, height = 10)

```



#Problem3

```{r}
demo=
  read_csv("data/demo.csv",skip=4) |>
  janitor::clean_names()


acc=
  read_csv("data/acc.csv") |>
  janitor::clean_names()
```
```{r}
#clean
demo_clean=
  demo |>
  filter(age>=21)|> 
  filter(!is.na(sex), !is.na(education)) |> 
  mutate(
    sex = factor(sex, levels=c(1, 2), labels =c("Male", "Female")),
    education = factor(education, 
                      levels=c(1, 2, 3),
                      labels=c("Less than high school", 
                                "High school equivalent", 
                                "More than high school"))
  )
demo_clean |>
  knitr::kable()

acc_long=
  acc |>
  pivot_longer(
    cols = min1:min1440,
    names_to = "minute",
    values_to = "mims_value"
  ) |>
  mutate(
    minute = as.numeric(str_remove(minute, "min")), 
    hour = floor((minute - 1) / 60)
  ) |>
  select(seqn, minute, hour, mims_value) 
acc_long |>
  knitr::kable()

```

```{r}
final_data=
  acc_long |>
  inner_join(demo_clean, by = "seqn") |>
  select(seqn, sex, age, bmi, education, minute, hour, mims_value, everything())
final_data
```

#table+visualization
```{r}
demographic_table=
  final_data |>
  distinct(seqn, sex, education) |>
  count(sex, education) |>
  pivot_wider(
    names_from = sex, 
    values_from = n, 
    values_fill = 0)
demographic_table

age_plot=
  final_data |>
  distinct(seqn, sex, education, age) |>
  ggplot(aes(x = education, y = age, fill = sex)) +
  geom_boxplot(alpha = 0.7, position = position_dodge(0.8)) +
  labs(
    title = "Age Distribution by Sex and Education Level",
    x = "Education Level",
    y = "Age",
    fill = "Sex"
  ) +
  theme_minimal() 
age_plot
```

#comment:
for education level that less than high school and high school equivalent, average age of female is more than average age of male. For more than high school education level, the average age of female is slightly lower than average age of male. 


#create a total activity variable for each participant and plot

```{r}
total_activity=
  final_data |>
  group_by(seqn, sex, age, education) |>
  summarise(
    total_mims = sum(mims_value, na.rm = TRUE),
    .groups = "drop"
  )


activity_plot=
  total_activity |>
  ggplot(aes(x = age, y = total_mims, color = sex)) +
  geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE) +
  facet_wrap(~ education) +
  labs(
    title = "Total Daily Activity by Age, Sex, and Education",
    x = "Age",
    y = "Total Daily Activity",
    color = "Sex"
  ) +
  theme_minimal()
activity_plot
```

#comment:
For high schoo equivalent and more than high school, females tend to shower a shower total daily activity than male. for less than high school education leve, females shows a higher total daily acitivity from age 20 to age 50, than shows a lower total daily activity from age 50 to age 80. For morethan high school education level, both male and female has smaller range of total daily activity compared to other educaation level groups. 




#three-panel plot that shows the 24-hour activity
```{r}
hourly_activity=
  final_data |>
  group_by(seqn, sex, education, hour) |>
  summarise(
    hourly_mims = mean(mims_value, na.rm = TRUE),
    .groups = "drop"
  ) |>
  group_by(sex, education, hour) |>
  summarise(
    mean_hourly_mims = mean(hourly_mims, na.rm = TRUE),
    se_hourly_mims = sd(hourly_mims, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

hourly_plot=
  hourly_activity |>
  ggplot(aes(x = hour, y = mean_hourly_mims, color = sex)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = mean_hourly_mims - se_hourly_mims,
                  ymax = mean_hourly_mims + se_hourly_mims,
                  fill = sex),
              alpha = 0.2, color = NA) +
  facet_wrap(~ education, ncol = 1) +
  labs(
    title = "24-Hour Activity Patterns by Education Level and Sex",
    x = "Hour of Day",
    y = "Hourly Activity",
    color = "Sex",
    fill = "Sex"
  ) +
  theme_minimal() +
  scale_x_continuous(breaks = seq(0, 23, by = 3))
hourly_plot
```
#comment:

For all education level, the hourly activity gradually increase from the morning, reach its peak at noon, and then gradually decrease. For high school equivament and more than high school, hourly acivity for female is greater than male. for less than high school education level, male in the morning to noon has higher hourly activity than female. 














